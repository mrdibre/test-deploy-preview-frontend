name: BE Preview
on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# ðŸ‘‡ grant OIDC + allow checkout
permissions:
  id-token: write
  contents: read

jobs:
  upsert:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Preview Upsert
        uses: ./
    with:
      state: upsert
      preview_id: ${{ github.head_ref }}
      be_branch: ${{ github.head_ref }}
      ecr_repo_frontend: 654654469708.dkr.ecr.us-west-2.amazonaws.com/frontend
      ecr_repo_backend: 654654469708.dkr.ecr.us-west-2.amazonaws.com/cdk-hnb659fds-container-assets-654654469708-us-west-2
      aws_region: us-west-2
      role_to_assume: arn:aws:iam::654654469708:role/test-preview-deploy-role
      cluster_arn: arn:aws:ecs:us-west-2:654654469708:cluster/server
      alb_listener_https_arn: arn:aws:elasticloadbalancing:us-west-2:654654469708:listener/app/test-preview/d4f4384d24105f76/b6f473ec1f2285c9
      hosted_zone_id: Z103926820UDM5MIWV6X1
      domain: deploy-preview.mrdibre.com

  teardown:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Preview Teardown
        uses: ./
    with:
      state: teardown
      preview_id: ${{ github.head_ref }}
      ecr_repo_frontend: 654654469708.dkr.ecr.us-west-2.amazonaws.com/frontend
      ecr_repo_backend: 654654469708.dkr.ecr.us-west-2.amazonaws.com/cdk-hnb659fds-container-assets-654654469708-us-west-2
      aws_region: us-west-2
      role_to_assume: arn:aws:iam::654654469708:role/test-preview-deploy-role
      cluster_arn: arn:aws:ecs:us-west-2:654654469708:cluster/server
      alb_listener_https_arn: arn:aws:elasticloadbalancing:us-west-2:654654469708:listener/app/test-preview/d4f4384d24105f76/b6f473ec1f2285c9
      hosted_zone_id: Z103926820UDM5MIWV6X1
      domain: deploy-preview.mrdibre.com
